zmActivities=(function(){var p=980+225+65,n="/nact/load",s=n+"?signkey="+zmConfig.signkey+"&time="+zmConfig.time+"&viewerId="+zmConfig.viewerId,m=false,A,e,w,h=false,d=false,u=false,y,f,B,q,j,z=false,C,H,x,l=location.host=="me.zing.vn";function F(K){var I={type:"new",fromid:0,limit:10},J=function(M){if(M.errorCode==0){zm("#friend-activities").html(M.data);A=M.firstId;e=M.lastId;k(M.NIds);var L=zm(w.getElement()).children().get(0)[0];if(L.scrollHeight==L.offsetHeight){b("old",e)}try{if(!zmConfig.signkey){zmConfig.signkey=M.authKey}if(!zmConfig.time){zmConfig.time=M.time}if(!zmConfig.viewerId){zmConfig.viewerId=M.viewerId}}catch(N){}}else{K=K||0;K++;if(K<10){setTimeout(function(){F(K)},1000)}else{D()}}};if(l){zm.post(n,I,{dataType:"json"},J,D)}else{zm.getJSON("http://me.zing.vn"+n+"?"+zm.param(I),J)}}function b(K,L,I){if(h||!L){return}if(K=="old"){zm("#friend-moreactivities").html('<div style="padding: 7px 0;"><img src="'+zmConfig.IMAGE_URL+'/v3/images/loading_small.gif" /></div>')}h=true;var J=s+"&type="+K+"&fromid="+L+"&limit="+(I||5);if(K=="old"){setTimeout(function(){i(J,K)},1000)}else{i(J,K)}}function i(J,K){var L=function(M){if(M.errorCode==0){if(K=="new"){G(M);A=M.firstId}else{if(K=="old"){zm("#friend-activities").append(M.data);zm("#friend-moreactivities").empty();e=M.more==0?null:M.lastId;k(M.NIds)}}}else{if(K=="old"){e=null;zm("#friend-moreactivities").empty()}}h=false},I=function(){h=false;e=null;if(K=="old"){zm("#friend-moreactivities").html("Có lỗi xảy ra, vui lòng thử lại sau.")}};if(l){zm.get(J,{dataType:"json"},L,I)}else{zm.getJSON("http://me.zing.vn"+J,L)}}function o(K){if(!K||typeof zmfw=="undefined"){return}if(f){var J=zm(f).find(".zmchat-friendAva");J.removeClass("loading");J.children().show()}f=K;if(zm.data(K,"activities.loaded")!=1){var I=zm(K).find(".zmchat-friendAva");I.addClass("loading");I.children().hide();zm.data(K,"activities.loaded",1);setTimeout(function(){a(K)},200)}else{a(K)}}function a(I){zmfw.showFeed(I,zm.intval(zm(I).attr("feedid")),{dboxClass:"disbox_stt_quickview activity",ignoreImages:"#zmdbox .rowcommentlt img",minTop:10,position:"fixed",width:532,group:"zmcog.activities",beforeShow:function(){var J=this.find(".zmchat-friendAva");J.removeClass("loading");J.children().show();zm("#zmdbox").data("clickoutside.group","zmcog.activities")},beforeHide:function(){if(d){d=false;f=null}}})}function g(I){if(I&&I==f){zm(I).hideDisplaybox();f=null}}function G(M){if(!M){return}var K=zm("#friend-tmpactivities");if(M.data){K.append(M.data)}var J=K.children();if(z||J.size()<1){return}z=true;var I=zm("#friend-activities"),L,P="friendAct_"+Math.floor(Math.random()*10000);L=K.outerHeight();var O=zm.createElement("DIV",{id:P},{position:"relative"}),N=zm.createElement("DIV",{"class":"cover"});I.prepend(O);zm("#"+P).append(N).append(J);I.css({position:"","margin-top":-L+"px"});zm("#"+P+" .cover").show().fadeOut(1000,function(){z=false;var R=this.parent(),S=R.children(),Q=[];S.each(function(){this.id&&Q.push(this.id.substr(5))});this.remove();zm("#friend-activities").prepend(R.children());R.remove();k(Q);G(true)});setTimeout(function(){I.slide({duration:200,start:-L,end:0})},50)}function k(J){if(!J){return}if(J===true){zm("#friend-activities").children().click(r).hover(v,E)}else{for(var I=0,L;L=J[I];I++){var K=zm("#nact_"+L);if(K.size()<1){continue}K.attr("data-nid",L);K.click(r).hover(v,E)}}}function r(){if(B){clearTimeout(B)}if(q){clearTimeout(q)}var I=this;I=zm(I).parents(".zmchat-friendItem");var J=I[0];if(y!=J){if(f==J){g(J);d=false}else{o(J);d=true}}else{d=true}y=null;return false}function v(){if(B){clearTimeout(B)}var I=this;if(d||I==f){return}B=setTimeout(function(){if(u){return}y=I;o(I)},500)}function E(){if(B){clearTimeout(B)}}function t(){if(zm.hasStorage){var I=zm("#friend-cacheactivities"),J;zm("#friend-activities").children().each(function(K){if(K>=10){return false}if(K==9){J=zm.intval(this.dataset.nid)}I.append(this.cloneNode(true))});zm.storage.put("activities."+zmConfig.viewerId,{data:I.html(),fid:A,lid:J},600)}}function D(){setTimeout(F,120000)}function c(){return typeof zmCommon!="undefined"&&zmCommon.TESTUSERS&&zmCommon.TESTUSERS.indexOf(zmConfig.viewerName+" ")>0}return{canTest:function(){return !!zmConfig.isCertificate||zmConfig.totalFriend>=20||(typeof zmCacheFriends!="undefined"&&zmCacheFriends.length>=20)||c()},canShow:function(){var J=0;if(this.canTest()){var I=zm.getViewport();if(I.width>p){J=1}}return !!J},isFeedSelected:function(){return d},autoResize:function(J){if(!H){H=zm("#zmchat-rheader").outerHeight(true)}var K=zm.getViewport().height,I=J?K-H:Math.floor((K+1)/2);I-=C;w.setHeight(I)},add:function(){if(m){return}m=true;var I=zm.getViewport();this.moveContent();zm("#zmchat-rpopup").prepend('<div id="friendactwp"><div id="friendact-title" class="friendact-title">Bạn tôi đang làm gì?</div></div>');C=zm("#friendact-title").outerHeight(true);w=new zm.ScrollableUI({content:'<div id="friend-tmpactivities" style="position: absolute; top: -9999px; left: -9999px;"></div><div id="friend-cacheactivities" style="display:none"></div><div id="friend-activities"><div style="text-align: center; padding-top: 4px;">Đang cập nhật...</div></div><div id="friend-moreactivities" style="text-align: center; background-color: #F0F3F7;"></div>',width:209,uiClass:"activity",height:Math.floor((I.height+1)/2)-C,onscroll:function(L,K,J){u=true;if(j){clearTimeout(j)}f=document.body;g(f);J==1&&b("old",e);j=setTimeout(function(){u=false},200)}}).init();zm("#friendactwp").append(w.getElement());F();zmNotifications.notify("notify.zo",function(){b("new",A)});zmChat.onAutoresize(function(J){w.setHeight(J-zm("#friendact-title").outerHeight(true))});zm(document).mousemove(function(){if(q){clearTimeout(q)}if(d){return}var J=this;q=setTimeout(function(){var N=zm(J).parents();if(N.filter("body").size()<1){return}N[N.size()]=J;for(var L=0,M;M=N[L];L++){var O=M.id,K=M.className;if(O=="zmdbox"||O=="friendactwp"||O=="zm-emo-list"||O=="zme-autocomplete-results"||O=="mppopup"||(K&&K.indexOf("zme-boxy")>=0)||(K&&K.indexOf("zme_notify")>0)){return}}y=null;g(f)},200)});zm("iframe").bind("mouseover",function(){if(d||zm(this).parents("#zmdbox").size()>0){return}y=null;g(f)})},getHeight:function(){return zm("#friendactwp .zmscrollableui_wrapper")[0].offsetHeight},loadMore:function(){b("old",e)},setHover:function(I){f=I},moveContent:function(K){var L="addClass";if(K){L="removeClass"}zm("#header .zingmain")[L]("moveLeft");zm("#www-warp")[L]("moveLeft");this.showing=!K;if(x){for(var J=0,I;I=x[J];J++){I(!K)}}},onSwitchUI:function(I){if(!x){x=new Array()}zm.isFunction(I)&&x.push(I)}}})();