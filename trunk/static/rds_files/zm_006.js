zmCore.install("autocomplete",{enableAutocomplete:function(r,d){if(!r){return false}this.disableAutocomplete();var s={};zm.extend(s,zm.autocomplete.defOptions,d);s.url=zm.isString(r)?r:"";var j=this,o=new zm.autocomplete.selector(this,s),i=new zm.autocomplete.cache(s),e="";zm.isString(r)?e=r:i.add("",r);var a=0,p=false;var t=function(y){a=1;var w=y.keyCode||y.which,z=o.isVisible(),u=y.type=="keydown"||zm.browser.opera,v=s.useCtrlKeyOnChange;switch(w){case 38:if(u){y.stopAllHandlers=true;if(z){y.preventDefault();o.prev()}else{if(v){n(this)}}}break;case 40:if(u){y.stopAllHandlers=true;if(z){y.preventDefault();o.next()}else{if(v){n(this)}}}break;case 33:if(u){y.stopAllHandlers=true;if(z){y.preventDefault();o.pageUp()}else{if(v){n(this)}}}break;case 34:if(u){y.stopAllHandlers=true;if(z){y.preventDefault();o.pageDown()}else{if(v){n(this)}}}break;case 9:case 13:var x=o.getSelected();if(x&&z&&y.type!="keyup"){p=true;o.select(x,1)}if(p){y.stopAllHandlers=true;if(y.type=="keyup"){p=false}return false}break;case 27:if(z&&u){y.stopAllHandlers=true;o.hide();return false}break;default:n(this);break}return true},g=function(){!o.isVisible()&&(a++>1)&&n(this)},b=function(){!o.isVisible()&&n(this);a++},h=function(){setTimeout(function(){!zm.autocomplete.wBlur&&!zm.autocomplete.enterList&&o.hide()},200)},m=function(u){u.stopPropagation()};if(zm.browser.opera){this.keypress(t,-1)}else{this.keydown(t,-1).keyup(t,-1).keypress(t,-1)}this.click(g).focus(b).blur(h).mouseup(m);this.attr("autocomplete","off");if(s.disableAfterSelect){this.each(function(){var w,u=s.clearButton;if(zm.isString(u)&&u){w=u}else{w="zme-autocomplete-clear-"+ ++zm.plugins.autocomplete.count;zm(document.body).append('<a href="#" class="zme-autocomplete-clear" id="'+w+'" title="Nhập lại" style="display:none;"></a>')}zm.data(this,"autocomplete.clear",w);var v=this;zm("#"+w).click(function(){zm(this).hide();var x=zm.data(v,"autocomplete.value");if(x){v.value=x}zm(v).attr("disabled","").removeClass(s.disabledClass).focus();zm.isFunction(s.onEnable)&&s.onEnable(v,x);return false})})}this.each(function(){zm.data(this,"autocomplete",j);zm.data(this,"autocomplete.cache",i);zm.data(this,"autocomplete.callbacks",{keydown:t,keypress:t,keyup:t,click:g,focus:b,blur:h,mouseup:m})});function n(u){var v=zm.data(u,"autocomplete.timeout");v&&clearTimeout(v);v=setTimeout(function(){zm.data(zm("#zme-autocomplete-results")[0],"autocomplete.input",u);var y=s.beforeSearch,w=true;if(zm.isFunction(y)){w=y(u)}if(w==false){return}var x=c(u);if(x.length<s.minChars){l()}else{f(u,x,k,l)}},s.delay);zm.data(u,"autocomplete.timeout",v)}function c(u){if(zm.isFunction(s.getTerm)){return s.getTerm(u)}else{return u.value}}function k(u,v){if(zm.objectLength(v)>0&&a){o.setData(u,v);o.show();j.removeClass(s.loadingClass)}else{l()}}function l(){o.hide();j.removeClass(s.loadingClass)}function q(u,v){var w=u;if(zm.isFunction(s.parseData)){w=s.parseData(u)}s.cacheLength>0&&i.add(v,w);return w}function f(x,y,C,w){var B,A;if(s.cacheLength>0){B=i.load(y)}y=zm.trim(y.toLowerCase());if(s.hasGroup){A=0;zm.each(B,function(E,D){if(D&&D.list&&D.list.length){A+=D.list.length}})}else{A=zm.objectLength(B)}if(A>0){C(y,B)}else{if(e.length>0){j.addClass(s.loadingClass);var z=e,u=s.method.toLowerCase();if(s.makeUrl){z=s.makeUrl(y)}else{if(u!=="post"){z=e+"?"+s.query+"="+encodeURIComponent(c(x))}}switch(u){case"post":var v=s.postData;v.keyword=c(x);zm.post(z,v,{dataType:"json"},function(E){if(y==zm.trim(c(x)).toLowerCase()){var D=q(E,y);C(y,D)}},w);break;case"get":zm.get(z,{dataType:"json"},function(E){if(y==zm.trim(c(x)).toLowerCase()){var D=q(E,y);C(y,D)}},w);break;case"getjson":zm.getJSON(z,{},function(E){if(y==zm.trim(c(x)).toLowerCase()){var D=q(E,y);C(y,D)}},w);break}}else{o.empty();w()}}}return this},flushCache:function(){var a=zm.data(this[0],"autocomplete.cache");a&&a.flush()},disableAutocomplete:function(){this.each(function(){var c=zm.data(this,"autocomplete"),b=zm.data(this,"autocomplete.callbacks");if(b){for(var a in b){c.unbind(a,b[a])}}clearTimeout(zm.data(this,"autocomplete.timeout"));zm.removeData(this,"autocomplete");zm.removeData(this,"autocomplete.cache");zm.removeData(this,"autocomplete.timeout");zm.removeData(this,"autocomplete.callbacks");zm.removeData(this,"autocomplete.clear");zm.removeData(this,"autocomplete.value")});this.attr("autocomplete","");return this}},function(){zm.plugins.autocomplete.count=0;var a=zm.createElement("DIV",{id:"zme-autocomplete-results"},{display:"none"});zm(a).hover(function(){zm.autocomplete.enterList=true},function(){zm.autocomplete.enterList=false}).mouseup(function(b){b.stopPropagation()}).html('<div><div><ul id="zme-autocomplete-list"></ul></div></div><div class="notif_boxshadow" style="display: none;"><div class="ntifboxshd_right png" style="float:right"></div><div class="ntifboxshd_left png" style="float:left"></div><div class="ntifboxshd_center"></div></div>');zm(window).focus(function(){zm.autocomplete.wBlur=false}).blur(function(){zm.autocomplete.wBlur=true});zm(document).mouseup(function(){zm.autocomplete.curSelector&&zm.autocomplete.curSelector.hide()});zm.ready(function(){document.body.appendChild(a)},-1)});zmCore.autocomplete={defOptions:{maxItems:100,delay:500,minChars:2,matchCase:false,matchContains:false,cacheLength:30,autoFill:false,hoverAutoFill:false,selectFirst:false,useCtrlKeyOnChange:true,formatItem:false,onItemSelected:false,method:"GET",query:"q",postData:{},searchResponse:true,highlight:function(g,e,b){var a="g";if(!b.matchCase){a+="i"}var d=b.matchContains,f=new RegExp((d?"(":"(^|\\W+)(")+e.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)",a),c=d?"<strong>$1</strong>":"$1<strong>$2</strong>";return ViString.replace(f,c,g)},fixShadow:false,scroll:true,scrollHeight:200,pageItems:10,disableAfterSelect:false,maxDisabledTextLength:0,position:"absolute",excludedClasses:"",loadingClass:"zme-autocomplete-loading",itemClass:"zme-autocomplete-item",activeItemClass:"zme-autocomplete-activeItem",disabledClass:"zme-autocomplete-disabled",coverClass:"",coverListClass:"zme-autocomplete-border",listClass:""}};zmCore.autocomplete.cache=function(b){var d={},c=0;function a(h){var e,f=-1;for(var g in d){g=g.toString();if(g.length<=f){continue}if(ViString.indexOf(g,h,"i")==0){e=d[g];f=g.length}}return e}return{settings:b,add:function(e,f){if(c>this.settings.cacheLength){this.flush()}if(!d[e]){c++}d[e]=f},load:function(f){if(!c){return null}var e,h=this.settings;if(d[f]){e=d[f];if(zm.isFunction(h.search)){e=h.search(e,f,true)}}else{var g=a(f);if(zm.isFunction(h.search)){e=h.search(g,f,false)}var i=f.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1");if(!e){e=zm.isArray(g)?new Array():{}}zm.each(g,function(l,q){var o=(h.matchContains?"(":"(^|\\W+)(")+i+")(?![^<>]*>)",j=h.matchCase?"g":"gi";if(h.hasGroup){var p=q.list,n=new Array();q=zm.extend({},q);zm.each(p,function(r,s){var m=s;if(zm.isFunction(h.formatCacheSearch)){m=h.formatCacheSearch(s)}if(zm.isString(m)&&ViString.search(new RegExp(o,j),m)>=0){n.push(s)}});q.list=n;e[l]=q}else{var k=q;if(zm.isFunction(h.formatCacheSearch)){k=h.formatCacheSearch(q)}if(zm.isString(k)&&ViString.search(new RegExp(o,j),k)>=0){e[l]=q}}});if(!h.url){this.add(f,e)}}return e},flush:function(){d={};c=0}}};zmCore.autocomplete.selector=function(h,j){var c=new Array(),i=-1,f,g=false,d=j;function b(){if(d.autoFill){if(this.getSelected()){var l=zm.data(this.getSelected(),"autocomplete.item");if(l){var k=l.key;if(zm.isFunction(d.formatInput)){k=d.formatInput(l.value,l.group)}if(k==false){k=l.key}h[0].value=k}}}}function e(){var k=this;zm("#zme-autocomplete-list li.zme-autocomplete-item").each(function(){zm(this).hover(function(){c[i]&&zm(c[i]).removeClass(d.activeItemClass);i=zm.inArray(this,c);d.hoverAutoFill&&b();zm(this).addClass(d.activeItemClass);f=this},function(){zm(this).removeClass(d.activeItemClass);f=null}).click(function(){var n=d.excludedClasses&&d.excludedClasses.split(" ");if(this.tagName.toLowerCase()=="li"&&!a(this,n)){k.select(this,0)}else{for(var l=0,m;m=zm(this).parents()[l];l++){if(a(m,n)){break}if(m.tagName.toLowerCase()=="li"){k.select(m,0);break}}}return d.bubbleClickOnItem})})}function a(n,o){if(o){var l=zm(n);for(var m=0,k;k=o[m];m++){if(l.hasClass(k)){return true}}}return false}return{setData:function(m,p){this.empty();if(!m&&!p&&zm.objectLength(p)==0){return}var q=0,r,A,t=zm("#zme-autocomplete-list"),s=zm.createElement("LI",{"class":d.itemClass});if(zm.isFunction(d.addHeader)){r=d.addHeader(m,s)}if(r){zm(s).html(r);t.append(s);zm.data(s,"autocomplete.item",{key:m,value:"footer"});c[q]=s}else{delete s}for(var n in p){if(q>=d.maxItems){break}if(d.hasGroup){if(p[n].list&&p[n].list.length>0){var z=p[n].title,y=p[n].list,l=zm.createElement("LI"),v=zm.createElement("UL");if(zm.isFunction(d.formatTitle)){z=d.formatTitle(z,n)}else{z="<h3>"+z+"</h3>"}d.groupClass&&zm(l).addClass(d.groupClass);zm(l).append(z).append(v);var o=1;for(var u in y){var x=(d.groupMaxItems&&d.groupMaxItems[n])||0;if(q>d.maxItems||(x>0&&o>x)){break}if(this.renderItem(m,zm.isArray(y)?y[u]:u,y[u],n,q,v)){q++;o++}}zm.isFunction(d.formatGroup)&&d.formatGroup(l,n,p[n]);t.append(l)}}else{this.renderItem(m,zm.isArray(p)?p[n]:n,p[n],null,q,t[0])&&q++}}var w=zm.createElement("LI",{"class":d.itemClass});if(zm.isFunction(d.addFooter)){A=d.addFooter(m,w)}if(A){zm(w).html(A);t.append(w);zm.data(w,"autocomplete.item",{key:m,value:"footer"});c[q]=w}else{delete w}if(d.selectFirst){this.move(1)}e.call(this)},renderItem:function(k,q,n,p,l,o){if(!n){return false}var r=zm.createElement("LI",{"class":d.itemClass}),m=n.toString(),s;if(zm.isFunction(d.formatItem)){s=d.formatItem(n,q,p,d.maxItems,r)}if(s!=false){m=s||m;if(zm.isFunction(d.highlight)){m=d.highlight.call(this,m,k,d)||m}zm(r).html(m);zm.data(r,"autocomplete.item",{key:q,value:n,group:p});o.appendChild(r);c[l]=r;return true}return false},isVisible:function(){return g},show:function(){if(c.length==0){return}var l=d.followElement?zm(d.followElement):h;if(!l){return}zm.isFunction(d.beforeShow)&&d.beforeShow(h[0]);var x=zm("#zme-autocomplete-results"),q,v,n,s=l.outerHeight(),p=zm.intval(x.css("border-left-width"))+zm.intval(x.css("border-right-width"));switch(d.position){case"absolute":q=l.offset(true);break;case"fixed":q=l.offset();break}v=q.top+s;if(typeof d.offsetLeft=="number"){v+=d.offsetTop}n=q.left;if(typeof d.offsetLeft=="number"){n+=d.offsetLeft}if(d.position=="fixed"&&zm.browser.msie&&zm.browser.version<7){if(!zm.data(x[0],"autocomplete.fixPosition")){zm(window).scroll(function(){x.css({top:(v+document.documentElement.scrollTop)+"px",left:(n+document.documentElement.scrollLeft)+"px"})});zm.data(x[0],"autocomplete.fixPosition",true)}var k=l.offset(true);x.css({position:"absolute",top:(k.top+s)+"px",left:k.left+"px"})}else{x.css({position:d.position,top:v+"px",left:n+"px"})}g=true;zm("#zme-autocomplete-list").attr("class",d.listClass);zm("#zme-autocomplete-list").parent().attr("class",d.coverListClass);var u=zm("#zme-autocomplete-results").children(),w=d.coverClass;if(d.fixShadow){u.get(0).attr("class","popup_edge_shadow");u.get(1).show();w+=" boxshadow_popup"}else{u.get(0).attr("class","");u.get(1).hide()}x.css("width",(d.width||l.outerWidth(false)-p)+"px").attr("class",w).show();x.css("z-index",d.zIndex?d.zIndex:"");var t=zm("#zme-autocomplete-list");if(d.scroll){t[0].scrollTop=0;if(zm.browser.msie){var m=0;for(var r=0;r<c.length;r++){m+=c[r].offsetHeight}if(m>d.scrollHeight){t.css("height",d.scrollHeight+"px")}else{t.css("height",m+"px")}}else{t.css("maxHeight",d.scrollHeight+"px")}t.css("overflow","auto")}else{t.css(zm.browser.msie?"height":"maxHeight","").css("overflow","")}zm.autocomplete.curSelector=this},hide:function(){if(this.isVisible()){zm.isFunction(d.beforeHide)&&d.beforeHide(h[0]);g=false;zm("#zme-autocomplete-results").hide();zm.autocomplete.curSelector=null}},move:function(o,k){c[i]&&zm(c[i]).removeClass(d.activeItemClass);i+=o;if(i<0){i=c.length-1}else{if(i>=c.length){i=0}}if(!c[i]||!zm(c[i]).hasClass("zme-autocomplete-item")){if(!k){k=0}if(k<c.length-1){this.move(o,k+1)}return}b.call(this);zm(c[i]).addClass(d.activeItemClass);f&&zm(f).removeClass(d.activeItemClass);f=null;if(d.scroll){var p=zm("#zme-autocomplete-list"),q=0,l=p[0].scrollTop,n=p[0].clientHeight;for(var m=0;m<i;m++){q+=zm(c[m]).outerHeight()}if(q+zm(c[i]).outerHeight()-l>=n){p[0].scrollTop=q+zm(c[i]).outerHeight()-n}else{if(q<l){p[0].scrollTop=q}}}},next:function(){c.length>1&&this.move(1)},prev:function(){c.length>1&&this.move(-1)},pageUp:function(){if(c.length>1){(i-d.pageItems)<0?this.move(-i):this.move(-d.pageItems)}},pageDown:function(){if(c.length>1){(i+d.pageItems)>=c.length?this.move(c.length-1-i):this.move(d.pageItems)}},getSelected:function(){if(f){return null}return c[i]},empty:function(){zm("#zme-autocomplete-list").empty();c.splice(0,c.length);i=-1},select:function(s,q){var m=zm.data(s,"autocomplete.item");if(!m){return}var l=m.value;if(zm.isFunction(d.formatInput)){l=d.formatInput.call(h[0],l,m.group)}if(l==false){l=m.key}else{if(l!=true){if(d.disableAfterSelect){var o=d.maxDisabledTextLength;if(o>0&&zm.isString(l)){zm.data(h[0],"autocomplete.value",l);if(l.length>o){l=l.substr(0,o-3)+"..."}}h.attr("disabled","disabled").addClass(d.disabledClass);var n=zm("#"+zm.data(h[0],"autocomplete.clear"));if(!zm.isString(d.clearButton)||!d.clearButton){var p=h.offset(true),r=h.outerHeight(),k=h.outerWidth();n.css({top:Math.floor(p.top+(r-16>0?r-16:0)/2)+"px",left:Math.floor(p.left+k-17)+"px"})}n.show()}h.val(l)}}!d.disableAfterSelect&&h.focus();this.hide();i=-1;zm.isFunction(d.onItemSelected)&&d.onItemSelected.call(s,m.key,m.value,m.group,q)}}};