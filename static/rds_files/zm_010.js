var zmChat=(function(){var bS=true;var ce=120000,ad=30,y=30000,cx=30000,s=10000,bp=120000,cu=3000,bs=600;var R=200,m=10,aY=30*14,bo=161,k=(zm.browser.msie&&zm.browser.version<9&&288)||290,ao=200,a0=96,aj=86,ck=210+10+17*2+20;var v=1,L=2,ae=3;var aX={TEXT:"BUZZ!!",COLOR:"red"};var aJ={PREFIX_CODE:"#",STANDARD_COLORS:["000000","ff0000","008000","808000","0000ff","800080","008080","ffa500","ffc0cb","808080"]};var x={FRIENDITEM:"zmchat-friendItem-",FRIEND_CHATCONTENT:"zmchat-popup-content-",MSG_CONTENT:"zmchat-popup-ctnMsg-"};var au="Đang cập nhật...";FRIENDFILTER_ERRTEXT="Không tìm thấy người này",FRIENDFILTER_LABEL="Nhập tên để tìm kiếm",NOFRIEND_TEXT="Hiện không có người bạn nào online.",PROMOTE_MSG=(zm.browser.msie&&zm.browser.version<8)?'<div class="zmchat-promotemsg" style="padding: 4px 0 7px 0;color: #999;">Để sử dụng chức năng chat tốt hơn, bạn nên sử dụng trình duyệt <strong>Google Chrome</strong>. <a href="http://www.google.com/chrome/index.html?hl=vi&brand=CHMA&utm_campaign=vi&utm_source=vi-ha-apac-vi-bk&utm_medium=ha" target="_blank">Tải tại đây</a></div>':"";var cB=12;var b2,Z,aC,cb,a4,by,a2,g,b3,be,cG,aF={},cH,aB,n;var cE={},T={},bb={},aR={},b7={},br={},V={},aE={},aM={},H={},bO=new Array(),af={},av={},aH={},aD={},cd={},ax={},i={},cD=new Array();var M=false,B=true,cq=0,ay,cA=false,b6=false,aT=false,ap=0,cm=0,bn=true,b0=null,bE=new Array(),G=new Array(),cp=false,N=false,Y,I,aK={},cn=0,bf=0,ct=0,a1=0,bV,aq=false,O=false,X=false,bJ=true,bK,P={},j=zm.getViewport().width,a3,b8,ak,u,r;var S=zm.browser.msie&&zm.browser.version<7;var ac=function(cI){switch(cI){case"&":return"&amp;";case">":return"&gt;";case"<":return"&lt;";case'"':return"&quot;";case"\n":return"<br>"}return cI};function bI(){return new Date().getTime()}function bZ(){if(zm.browser.chrome&&zmChat.DEBUG_USERS.indexOf(zmChat.userId+", ")>-1){typeof console!="undefined"&&console.log.apply(console,arguments)}}function bl(cL){var cM=new Date(cL),cK=cM.getHours(),cJ=cM.getMinutes(),cI=Math.floor(cK/12);cK=cK>12?cK-12:cK;return cK+":"+(cJ<10?"0":"")+cJ+" "+(cI==0?"am":"pm")}function t(cN){var cL=new Date(),cP=new Date(cL.getTime()+cN*1000),cO=cP.getMonth(),cJ=cP.getDate(),cI=cL.getDate(),cM=cP.getMinutes(),cK=cP.getHours()+":"+(cM<10?"0":"")+cM+" ";if(cL.getMonth()==cO){if(cI==cJ){return cK+"hôm nay"}else{if(cJ-cI==1){return cK+"ngày mai"}}}return cK+cJ+"/"+(cO+1)+"/"+(cP.getYear()+1900)}function aa(cI){return zm.isString(cI)&&cI?zmConfig.PROFILE_URL+"/"+cI:"#"}function a9(cI){return cI.indexOf("http://")>-1?cI:"http://"+cI.substr(0,1)+".1.s50.avatar.zdn.vn/avatar_files/"+cI+".jpg"}function b4(cK){var cJ=cE[cK]&&cE[cK].d,cI=zm.isString(cJ)?cJ.split(" "):["Người này"];return cI[cI.length-1]}function a8(){if(typeof zmActivities=="undefined"){return}var cI=arguments[0];Array.prototype.splice.call(arguments,0,1);return zmActivities[cI].apply(zmActivities,arguments)}function bR(cI){var cK=zm("#friendactwp"),cJ=cK.size()<1;if(cI){if(cJ){a3.setHeight(cF()[0]);a8("add")}else{cK.show()}if(ay){at()}else{bJ=true;c(bJ)}zm("#zmchat-rpopup").append(zm("#zmchat-rheader"));zm("#zmchat-rheader").css("cursor","default");zm("#zmchat-turnticker").addClass("zmchat-off-parent").removeClass("zmchat-on-parent")}else{cK.hide();ay&&zm("#zmchat-rpopupmin").show();zm("#zmchat-topgrey").before(zm("#zmchat-rheader")[0]).hide();zm("#zmchat-rheader").css("cursor","");bQ();zm("#zmchat-turnticker").addClass("zmchat-on-parent").removeClass("zmchat-off-parent")}E(true,true);ba();f();bH();!cJ&&a8("moveContent",!cI)}function bc(){var cI=null;cI=a8("canShow");if(!cI){zm("#zmchat-turnticker").hide()}else{if(zm("#zmchat-rctn").css("display")=="none"){zm("#zmchat-turnticker").show()}}if(ab()==0||!bJ){return}X=cI}function cF(){var cJ=zm.getViewport().height,cN;if(!ay&&ay!=undefined){cN=zm("#zmchat-rheader").outerHeight(true)}else{var cM=zmChat.HEIGHT_RATIO||"5:5",cL=cM.split(":"),cK=parseFloat(cL[0]),cI=parseFloat(cL[1]),cO=cK+cI;cN=Math.floor(cJ*cK/cO)}return[cN,cJ-cN]}function E(cP,cM){var cJ=zm.getViewport(),cI=cJ.height-a0;if(X){var cL=cF();cI=cL[0]-aj;e(cL[1])}else{var cO=zm("#zmchat-friendlist"),cK=cO.children().size();if(cK<1){cI=18}else{var cN=cO.outerHeight();if(cN==0){cN=43*cK}if(cN<cI){cI=cN}}}!X&&cI>aY&&(cI=aY);a3.setHeight(cI);!cM&&az(cJ.height);!cP&&bU(cJ.width)}function az(cM,cI){if(!cM){cM=zm.getViewport().height}if(b8==undefined){b8=zm("#header").outerHeight()}var cL=cM-113-b8,cK=S?"height":"max-height",cJ=cE;if(cI&&cE[cI]){cJ={};cJ[cI]=cE[cI]}zm.each(cJ,function(cN){var cP=aE[cN];if(!cP){return}if(cL>ao){cL=ao}cE[cN].popupHeight=cL;var cO=zm("#zmchat-textAr-"+cN).height();if(cO>0){cL-=cO-20}cP&&cP.setHeight(cL);zm("#zmchat-popup-w"+cN).css(cK,cL+"px")})}function bU(cJ){if(j==cJ){return}var cQ=aU(cJ),cM;if(j>cJ){cM=0;while(cM<G.length&&cQ<20&&a1>1){zm("#zmchat-btnwp-"+G[ct]).hide();cQ+=a(G[ct]);ct++;a1--;cM++}}else{if(j<cJ){var cL,cN,cI,cP,cR,cO,cK;cM=0;while(cM<G.length&&cQ>bo+20){cL=G[ct-1];cN=G[ct+a1];if(!cL&&!cN){break}cR=a(cL);cO=a(cN);if(cO==0||cR<=cO){cP=cL;cI=cR;cK=true}else{cP=cN;cI=cO;cK=false}cQ-=cI;if(cI==0||cQ<20){break}cK&&ct--;zm("#zmchat-btnwp-"+cP).show();a1++;cM++}}}j=cJ;b(G.length>a1);bM()}function ag(){zm(window).focus(function(){aT=false;if(cm>0){zmNotifications.resetAlert();cm=0}if(!Y){Y=zm.storage.get("zmchat.focus."+zmChat.userId);zm("#zmchat-textAr-"+Y).focus()}}).blur(function(){aT=true}).bind("unload",function(){zm.each(cE,function(){a7(this.u,false)});zm.each(af,function(cI){an(cI)});zm.each(br,function(cJ,cI){zm.storage.put("zmchat.recentmsg."+zmChat.userId+"."+cJ,cI,86400)});if(ab()==2){D(1)}}).resize(function(){if(bJ){var cI=X;bc();cI!=X&&bR(X)}else{bc()}E()})}function z(cI,cJ){zm.isFunction(Z)&&Z(cI);zmChat.updateOnOff(cI,cJ)}function aZ(cM,cJ){if(!cA){if(!cM&&zm.hasStorage){try{var cI=zm.storage.get("zmchat."+zmChat.userId);if(cI){cI.list&&zmChat.onLoadFriends(cI.list,true);return}}catch(cN){}}b9();if(ay){cA=true;if(b2==undefined){if(!cJ){cJ=0}cJ<10&&setTimeout(function(){cA=false;aZ(true,cJ+1)},1000)}else{var cL=new Array();for(var cK in cE){cE[cK].f!==0&&!cg(cK)&&cL.push(cK)}zm.isFunction(b2)&&b2(cL)}}}}function bw(cM,cJ){cM=zm.intval(cM);var cI=cE[cM];if(cI&&cI.fontColor&&cJ.indexOf(aJ.PREFIX_CODE)!=0){cJ=aJ.PREFIX_CODE+cI.fontColor+" "+cJ}if(U(cJ)){cJ=cJ.replace(aX.REG,"$2")}ap++;var cL={to:cM,fromU:zmChat.userId,fromD:zmChat.userDisplayname,fromN:zmChat.username,msg:cJ,id:ap,time:new Date().getTime()};if(af[cM]){af[cM].status=false;delete af[cM].cacheMsg}bW(cL,true);if(aR[cM]==undefined){aR[cM]=new Array()}aR[cM].push(cL.id);zm.isFunction(cb)&&cb(cL);var cK=bI();cI.onlineTs=cK;if(cK-bf>=cx){bf=cK;aZ()}}function ar(cJ,cI){aC&&aC(cJ,cI);aH[cJ]=true}function a7(cK,cI){if(!bS&&cE[cK]&&af[cK]){var cJ=new Date().getTime();if(af[cK].timeout){clearTimeout(af[cK].timeout)}af[cK].timeout=setTimeout(function(){if(af[cK].status!=cI){af[cK].status=cI;zm.isFunction(by)&&by(cK,cI,cJ)}},cu)}}function W(){if(!cp){return}cp=false;var cI=new Array();for(var cJ=0,cK,cL;cK=bO[cJ],cL=cE[cK];cJ++){cI.push([cK,cL.d||"",cL.n||"",cL.f==undefined?"":cL.f,zm.inArray(cK,bE)>-1?1:0])}zm.isFunction(a4)&&a4(cI)}function bD(){if(!N){cp=true;if(I){clearTimeout(I)}I=setTimeout(W,500)}}function ca(cI){if(!cd[cI]){cd[cI]=true;zm.isFunction(a2)&&a2(cI)}}function cj(cJ,cL){if(!cJ){return}var cK=cJ.uname,cI=cJ.u;if((cK&&cK!=zmChat.username&&/^[a-z0-9][a-z0-9._]{2,}[a-z0-9]$/i.test(cK))||(cI&&zmChat.userId!=cI)){zm.isFunction(g)&&g(cJ,cL)}}function aP(cI,cJ){zm.isFunction(b3)&&b3(cI);if(cI.online!=undefined){zmChat.updateOnOff(cI.online,cJ)}}function h(cI,cJ){zm.isFunction(be)&&be(cI,cJ)}function aO(cI,cJ){zm.isFunction(cG)&&cG(cI,cJ)}function b5(){var cK=arguments[0];if(!cK){return}for(var cJ=0,cI;cI=cK[cJ];cJ++){try{cI.apply(window,arguments[1])}catch(cL){}}}function c(cI){b5(cH,[cI])}function e(){b5(aB,arguments)}function bH(){b5(n,arguments)}function bg(){for(var cK in i){var cN;if(cK==zmChat.userId){cN=zmChat.username}else{if(cE[cK]&&cE[cK].n){cN=cE[cK].n}}if(cN){var cL=aa(cN);for(var cJ=0,cM;cM=i[cK][cJ];cJ++){var cI=zm("#"+cM);if(cK==zmChat.userId){cI.addClass("zmechat_txtgrey")}cI.attr("href",cL)}}delete i[cK]}}function p(cI,cJ){if(ax[cI]==undefined){ax[cI]=new Array()}ax[cI].push(cJ)}function bX(cI,cJ){if(i[cI]==undefined){i[cI]=new Array()}i[cI].push(cJ)}function bt(cI){if(zm.inArray(cI,cD)==-1){cD.push(cI)}}function bQ(){var cI=zm.browser.msie?"selectstart":"mousedown";zm("#zmchat-rheader").unbindAll("click").click(function(){if(X){return}var cK=zm(this);if(cK.parents(".zmchat-icon-parent").size()>0){return}var cJ=zm("#zmchat-turnticker");if(cJ.css("display")!="none"){cJ.click()}else{cK.focus();if(zm("#zmchat-rctn").css("display")=="none"){at();b9();setTimeout(function(){if(!ay){aP({online:1},true)}else{var cL=bI();if(cL-cn>=y){cn=cL;aZ()}}},5)}else{F()}}}).unbindAll(cI).bind(cI,function(){return false});zm("#zmchat-rpopupmin").unbindAll("click").click(function(){zm("#zmchat-rheader").click()})}function Q(cI){zm.storage.put("zmchat.list."+zmChat.userId,cI,2592000,true);bJ=!!cI;if(X){bJ=true}c(bJ)}function at(){zm("#zmchat-rctn").show();if(X){zm("#zmchat-topgrey").show();zm("#zmchat-rpopupmin").hide();zm("#zmchat-turnticker").show()}else{zm("#zmchat-rpopupmin").show();zm("#zmchat-turnticker").hide()}Q(1)}function F(){zm("#zmchat-rctn").hide();if(a8("canShow")){zm("#zmchat-turnticker").show()}if(X){zm("#zmchat-topgrey").hide()}else{zm("#zmchat-rpopupmin").hide()}Q(0)}function aI(){if(!a3){a3=new zm.ScrollableUI({content:'<ul id="zmchat-friendlist"></ul>',width:209,onscroll:function(){typeof zmPW!="undefined"&&zmPW.hm()}}).init();zm("#zmchat-friendlistwp").append(a3.getElement())}}function K(cK){var cI="",cJ="";if(cK.s){cJ=cK.s.replace(/[&<>"]/g,ac);cI='<p><span class="zmechat-icostt"></span><span class="zmchat-stttext">'+cJ+"</span></p>"}return'<li class="zmchat-friendItem" id="'+x.FRIENDITEM+cK.u+'"><a href="'+aa(cK.n)+'" onclick="zmChat.chatWith('+cK.u+"); return false;\" onmouseover=\"typeof zmPW != 'undefined' && zmPW.sm(this, null, 'chat',"+cK.si+');" onmouseout="typeof zmPW != \'undefined\' && zmPW.hm();">			<div class="zmchat-friendAva"'+(cK.n?(' title="'+cK.n+'"'):"")+'><img src="'+a9(cK.a)+'" alt="" /></div>			<div class="zmchat-status"></div><div class="zmchat-friendName"><strong>'+cK.d+"</strong>"+cI+"</div></a></li>"}function ai(cI){var cL=zm.objectLength(cI);if(cL<=0){zm("#zmchat-message").html(NOFRIEND_TEXT)}else{ch();var cK="";for(var cJ=0;cJ<cL;cJ++){cK+=K(cI[cJ])}zm("#zmchat-friendlist").html(cK);zm("#zmchat-label").text("Chat ("+cL+")")}C(cI)}function bm(cJ,cI){var cK=zm.trim(cJ.d.toLowerCase()),cL=zm.trim(cI.d.toLowerCase());if(cJ.i==cI.i){return cK>cL?1:-1}else{if(cJ.i){return 1}else{return -1}}}function b1(){zm("#zmchat-filterClr").click(function(){var cI=zm("#zmchat-filterInput"),cJ=cI.val();if(cJ!=""){cc();cI.val("").focus()}zm(this).hide()}).mouseenter(function(){zm(this).addClass("zmchat-filterClr-active")}).mouseleave(function(){zm(this).removeClass("zmchat-filterClr-active")}).mousedown(function(){return false});zm("#zmchat-filterInput").focus(function(){if(this.value==FRIENDFILTER_LABEL){this.value=""}zm(this.parentNode).addClass("zmchat-filterFocus")}).blur(function(){if(!this.value){this.value=FRIENDFILTER_LABEL;zm(this.parentNode).removeClass("zmchat-filterFocus")}}).keyup(function(cK){if(bV){clearTimeout(bV)}var cJ=zm(this),cI=cK.keyCode==27;bV=setTimeout(function(){if(cI){cJ.val("")}var cL=cJ.val();if(cL&&cL!=FRIENDFILTER_LABEL){bh(cJ.val());zm("#zmchat-filterClr").show()}else{cc();zm("#zmchat-filterClr").hide()}},bs)}).keydown(function(cP){var cI=zm("#zmchat-friendlist").children(),cR=new Array();cI.each(function(){if(zm(this).css("display")!="none"){cR.push(this)}});var cN=zm.inArray(bK,cR),cJ=cN,cQ=true;bK&&zm(bK).removeClass("active");switch(cP.keyCode){case 38:if(cN<=0){cJ=cR.length-1}else{cJ=cN-1}bK=cR[cJ];zm(bK).addClass("active");cQ=false;break;case 40:if(cN>=cR.length-1||cN===-1){cJ=0}else{cJ=cN+1}bK=cR[cJ];zm(bK).addClass("active");cQ=false;break;case 13:if(bK){var cM=zm.intval(bK.id.substr(x.FRIENDITEM.length));bK=null;zmChat.chatWith(cM)}else{var cT=zm("#zmchat-filterInput").val();zmChat.chatWith(cT)}break;default:break}if(bK){var cK=0,cO=zm("#zmchat-friendlist")[0],cS=zm(bK).outerHeight(true);for(var cL=0;cL<cJ;cL++){cK+=zm(cI[cL]).outerHeight(true)}if(cK+cS-cO.scrollTop>=cO.clientHeight){cO.scrollTop=cK+cS-cO.clientHeight}else{if(cK<cO.scrollTop){cO.scrollTop=cK}}}return cQ})}function bh(cJ){if(b6||typeof cJ!=="string"){return}cJ=zm.trim(cJ);cJ=cJ.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1");var cI=0;zm.each(cE,function(){if(this.f!==0){var cM=this.d,cK=this.n,cQ=zm("#"+x.FRIENDITEM+this.u),cP=cQ.children();if(cM&&cQ&&cQ[0]){var cO=new RegExp("(^|\\s+)("+cJ+")","gi"),cN=ViString.search(cO,cM)>=0,cL=cK.indexOf(cJ)==0;if(cN||cL){cQ.show();cN&&cP.find(".zmchat-friendName strong").html(ViString.replace(cO,'<font color="#cc0000">$1$2</font>',cM));cI++;return}cQ.hide()}}});S&&zm("#zmchat-friendlist").css("height","auto");if(cI==0){zm("#zmchat-message").html(FRIENDFILTER_ERRTEXT).show()}else{zm("#zmchat-message").hide()}}function cc(){if(b6){return}zm.each(cE,function(){if(this.f!==0){var cI=zm("#"+x.FRIENDITEM+this.u);if(cI&&cI.size()>0){cI.find(".zmchat-friendName strong").html(this.d);cI.show()}}});E(true,true);if(zm("#zmchat-friendlist").children().size()==0){zm("#zmchat-message").html(NOFRIEND_TEXT).show()}else{zm("#zmchat-message").hide()}}function bd(){var cI=zm("#zmchat-filter");if(!cI){return}var cJ=cI.val();if(cJ&&cJ!=FRIENDFILTER_LABEL){bh(cJ)}}function aA(){zm("#zmchat-optionsList").html('<li><input id="zmchat-offline" class="checkBR" type="checkbox" '+(ay?"":' checked="checked"')+' onclick="zmChat.changeSetting(this)" /><label for="zmchat-offline">Offline</label></li>			<li><input id="zmchat-sound" class="checkBR" type="checkbox" '+(bn?' checked="checked"':"")+' onclick="zmChat.changeSetting(this)" /><label for="zmchat-sound">Sử dụng âm thanh</label></li>			<li><input id="zmchat-otherchat" class="checkBR" type="checkbox" '+(B?' checked="checked"':"")+' onclick="zmChat.changeSetting(this)" /><label for="zmchat-otherchat">Nhận tin nhắn từ người lạ</label></li>');aq=true}function ba(){var cI=zm("#zmchat-options");cI[0].onclick=function(){if(!aq){aA()}var cL=zm("#zmchat-optionsList"),cK=zm(this);if(cL.css("display")!="none"){cL.hide();cK.removeClass("active")}else{cK.addClass("active");var cJ=zm.getViewport();if(cJ.height+cJ.offsetY-zm("#zmchat-options").top()>106){cL.addClass("bottom")}else{cL.removeClass("bottom")}cL.show()}cK.focus();return false};cI.clickOutside(l).clickOutsideWith(zm("#zmchat-optionsList"))}function f(){zm("#zmchat-turnticker")[0].onclick=function(){bJ=true;zmChat.displayTicker(!X,true);return false}}function l(){zm("#zmchat-optionsList").hide();zm("#zmchat-options").removeClass("active")}function q(cI){try{aN().enableSound(cI)}catch(cJ){}}function bk(){if(!zmChat.params.flashVersion){return}var cM="http://"+zm.config.hostImage+"/swf/zmChat-"+zmChat.params.flashVersion+".swf",cJ="zmchat-player",cP={id:cJ,type:"application/x-shockwave-flash",width:"0",height:"0",data:cM},cI={movie:cM,allowScriptAccess:"always"};if(zm.browser.msie&&!zm.browser.opera){cP.classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"}if((!zm.browser.msie)||zm.browser.opera){var cO=zm.createElement("OBJECT",cP);for(var cL in cI){var cN=zm.createElement("PARAM");cN.setAttribute("name",cL);cN.setAttribute("value",cI[cL]);cO.appendChild(cN)}document.body.appendChild(cO)}else{var cK="<object ";for(var cL in cP){cK+=cL+'="'+cP[cL]+'" '}cK+=">";for(var cL in cI){cK+='<param name="'+cL+'" value="'+cI[cL]+'">'}cK+="</object>";zm("#zmchat-wrapper")[0].outerHTML=cK}}function aN(){return zm("#zmchat-player")[0]}function w(cK,cI){if(br[cK]){var cJ=br[cK].length;if(V[cK]==undefined){V[cK]=cJ}var cM=V[cK],cL;if(cI&&cM<=0){return null}if(!cI&&cM>=cJ-1){V[cK]=cJ;return""}cI?cM--:cM++;cL=br[cK][cM];V[cK]=cM;return cL}return null}function cr(cI){zm("#zmchat-emoBtn-"+cI).click(function(){zm(this).focus()}).attachEmoButtons("zmchat-textAr-")}function bN(cI){zm("#zmchat-buzzBtn-"+cI).click(function(){var cJ=this.id.substr(15);if(bI()-zm.intval(cE[cJ].lastBuzzTime)>=s){bw(cJ,"!buzz")}})}function bA(cI){zm("#zmchat-fontBtn-"+cI).click(function(){var cL=this.id.substr(15);if(!cE[cL]){return}if(!O){bC()}var cM=zm("#zmchat-colorsList");if(cM.css("display")!="none"){cM.hide();return}b0=cL;var cK=cE[cL].fontColor,cO=zm(this);if(cK){zm("#zmchat-colorsList").children().each(function(){if(cO.attr("rel")==cK){zm("#zmchat-colorsList").children().removeClass("selected");cO.addClass("selected");return false}})}else{var cJ=zm("#zmchat-colorsList").children();cJ.removeClass("selected");zm(cJ[0]).addClass("selected")}var cN=cO.left();if(S){cN-=zm("#zmchat").left()}cM.css("left",cN+"px").show();cO.focus()}).blur(function(){setTimeout(function(){zm("#zmchat-colorsList").hide()},200)}).attr("tabIndex","-1")}function cl(cI){zm("#zmchat-savessBtn-"+cI).click(function(){var cJ=this.id.substr(17);if(P[cJ]){h(cJ,function(){zmChat.onError({to:cJ,msg:'Nội dung chat này đã được lưu vào mục <a href="/apps/msg?params=/inbox">Tin nhắn</a>.'});bY(cJ)});bP(cJ,false)}})}function a5(cJ){var cI=function(cN){var cL=this.id.substr(14);if(af[cL]==undefined){af[cL]={status:false}}var cO=cN.keyCode==13,cM=zm(this).val()=="";if(cO){clearTimeout(cE[cL].typingTimeout)}else{a7(cL,!cM);cN.keyCode!=38&&cN.keyCode!=40&&bF(cL,zm.trim(this.value))}};zm("#zmchat-textAr-"+cJ).keypress(function(cL){var cN=this.id.substr(14);if(cN&&cL.keyCode==169&&!cL.altKey){bw(cN,"!buzz")}if(cN&&cL.keyCode==13&&!cL.shiftKey){var cM=(new Date()).getTime();if(bb[cN]!=undefined){if(cM-bb[cN]<500){return false}}bb[cN]=cM;var cO=zm(this);var cP=zm.trim(cO.val());if(cP){bw(cN,cP);cO.val("");delete V[cN]}return false}}).keyup(function(cN){var cM=this.id.substr(14),cL=this;if(cN.keyCode==27){cM&&cf(cM,true)}cI.call(this,cN)}).keydown(function(cM){if(cM.keyCode==38||cM.keyCode==40){var cL=this.id.substr(14),cN=w(cL,cM.keyCode==38);if(zm.isString(cN)){zm(this).val(cN);return false}}else{if(cM.keyCode!=13&&cM.keyCode!=8&&this.value.length>R){return false}}}).change(function(cL){if(this.value.length>R){this.value=this.value.substr(0,R)}cI.call(this,cL)}).focus(function(){var cL=this.id.substr(14);a6(cL);Y=cL;zm.storage.put("zmchat.focus."+zmChat.userId,Y,3600)}).blur(function(){a6(this.id.substr(14),false);setTimeout(function(){if(!aT){Y=null;zm.storage.remove("zmchat.focus."+zmChat.userId)}},150)}).autoResize({onresize:function(cN,cP){if(cN>=104){zm(this).css("overflow-y","auto");return false}zm(this).css("overflow-y","");var cL=this.id.substr(14);if(aE[cL]){var cO=aE[cL].getHeight();if(cN>cP&&cO<=64){return false}var cM=cE[cL].popupHeight-(cN-20);aE[cL].setHeight(cM).scrollToEnd();zm("#zmchat-popup-w"+cL).css(S?"height":"max-height",cM+"px")}}});var cK=zm.storage.get("zmchat.recentmsg."+zmChat.userId+"."+cJ);if(cK&&!br[cJ]){br[cJ]=cK}}function bF(cJ,cL){if(cL==""){return}if(!br[cJ]){br[cJ]=new Array()}var cK=br[cJ],cI=af[cJ];if(!cI.cacheMsg){cI.cacheMsg=true;if(cK.length>9){cK.splice(0,1)}cK.push(cL)}else{cK[cK.length-1]=cL}}function an(cI){if(af[cI]&&af[cI].cacheMsg){br[cI].splice(br[cI].length-1,1);delete af[cI].cacheMsg}}function aw(cJ){o(cJ);var cI=zm("#zmchat-popup-"+cJ),cK=cI.children(".zmchat-popup-header");cI.css("visibility","").hide();cK.mouseup(function(cL){cL.stopPropagation()});cK.children("a").click(function(){cf(cJ);return false});cK.children("span").mouseenter(function(){zm(this).children(".zmchat-popup-min").addClass("zmchat-popup-min-active")}).mouseleave(function(){zm(this).children(".zmchat-popup-min").removeClass("zmchat-popup-min-active")}).click(function(){if(this.nodeName.toLowerCase()!="a"){bj(cJ)}});zm("#zmchat-popup-w"+cJ).click(function(){zm("#zmchat-textAr-"+cJ).focus()})}function bC(){zm("#zmchat").append('<ul id="zmchat-colorsList" style="display:none">			<li class="selected" rel="000000"><div style="background-color: #000000; "></div></li>			<li rel="ff0000"><div style="background-color: #ff0000; "></div></li>			<li rel="008000"><div style="background-color: #008000; "></div></li>			<li rel="808000"><div style="background-color: #808000; "></div></li>			<li rel="0000ff"><div style="background-color: #0000ff; "></div></li>			<li rel="800080"><div style="background-color: #800080; "></div></li>			<li rel="008080"><div style="background-color: #008080; "></div></li>			<li rel="ffa500"><div style="background-color: #ffa500; "></div></li>			<li rel="ffc0cb"><div style="background-color: #ffc0cb; "></div></li>			<li rel="808080"><div style="background-color: #808080; "></div></li>			</ul>');zm("#zmchat-colorsList").children().click(function(){var cJ=this;if(this.nodeName.toLowerCase()=="div"){cJ=this.parentNode}var cK=zm(cJ);if(cE[b0]){var cI=cK.attr("rel");cE[b0].fontColor=cI;zm("#zmchat-colorsList").children().removeClass("selected");cK.addClass("selected");zm("#zmchat-textAr-"+b0).css("color","#"+cI).focus()}});O=true}function bv(cO,cJ,cM,cN,cI){if(cJ==undefined){cJ=true}var cK=cO.u;if(zm.inArray(cK,bO)==-1){bO.push(cK)}var cL=cE[cK];if(cL==undefined){cL={u:cK,d:cO.d,f:cO.f};cO.n&&(cL.n=cO.n);cE[cK]=cL;aZ()}if(!am(cK)){aL(true,cJ);aQ(cK,cN)}cJ&&bT(cK,cM,cI);bu(cK,cJ,false);!cN&&cO.f!==0&&co(cL,true)}function aQ(cL,cO){var cN=cE[cL],cI=zm.createElement("DIV",{id:"zmchat-btnwp-"+cL,"class":"zmchat-friendBtnwp"}),cK=zm.createElement("DIV",{id:"zmchat-btn-"+cL,"class":"zmchat-friendBtn",onmousedown:"return false;"}),cM=zm.createElement("DIV",{"class":"zmchat-closeBtn",title:"Đóng"},{display:"none"}),cJ='<span class="zmchat-btnCtn boldText'+((cN.f!==0&&!cO)?"":" zmchat-nobg")+'">'+cN.d+"</span>";zm(cK).click(function(){var cS=this,cR=zm(cS);if(cR.hasClass("zmchat-closeBtn")){return}if(cS.id.indexOf("zmchat-btn")<0){cS=cS.parentNode}var cQ=zm.intval(/\d+/.exec(cS.id)[0]);if(zm.inArray(cQ,bE)>-1){bj(cQ)}else{bT(cQ)}}).mouseenter(function(){zm(cM).show()}).mouseleave(function(){zm(cM).hide()}).html(cJ).append(cM);zm(cI).append(cK).append(bz(cL)+'<div class="clr"></div>');zm("#zmchat-btns").append(cI);var cP=new zm.ScrollableUI({content:'<div id="'+x.FRIEND_CHATCONTENT+cL+'">'+PROMOTE_MSG+"</div>",width:274,height:200}).init();zm("#zmchat-popup-w"+cL).append(cP.getElement());aE[cL]=cP;zm(cM).click(function(){if(this.parentNode.id){var cQ=this.parentNode.id.substr(11);cf(cQ)}}).mouseenter(function(){zm(this).addClass("zmchat-closeBtn-active")}).mouseleave(function(){zm(this).removeClass("zmchat-closeBtn-active")});G.push(cL);a5(cL);cr(cL);bN(cL);bA(cL);cl(cL);aw(cL);az(null,cL)}function bz(cI){var cK=cE[cI],cL=aa(cK.n),cJ="zmchat-pava-"+Math.floor(Math.random()*10000),cM="";if(cK.a){cM=a9(cK.a)}else{p(cI,cJ);ca(cI)}if(!cK.n){bt(cI)}return'<div id="zmchat-popup-'+cI+'" class="zmchat-popup" style="visibility: hidden">			<div class="zmchat-popup-header"><a href="#" class="zmchat-popup-close" title="Đóng"></a>			<span class="zmchat-popup-hleft"><a href="'+cL+'" class="zmchat_avataruser"><img id="'+cJ+'" width="30px" height="30px" src="'+cM+'" /></a><span class="zmchat-popupinfo"><a href="'+cL+'" class="zmchat-popup-title" title="'+cK.d+'">'+cK.d+'</a><span class="zmchat_txtusername" title="'+cK.n+(cK.n?"":'" style="visibility:hidden')+'">&nbsp;- '+cK.n+'</span></span><span class="zmchat-popup-min" title="Thu nhỏ"></span></span></div>			<div class="zmchat-popup-content" id="zmchat-popup-w'+cI+'"></div>			<div class="zmchat-toolbar">			<span class="zmchat-tbbtn zmchat-emoBtn" id="zmchat-emoBtn-'+cI+'" rel="for_'+cI+'" title="Mặt cười" tabindex="-1"></span>			<span class="zmchat-tbbtn zmchat-fontBtn" id="zmchat-fontBtn-'+cI+'" title="Chọn màu chữ" tabindex="-1"></span>			<span class="zmchat-tbbtn zmchat-buzzBtn" id="zmchat-buzzBtn-'+cI+'" title="BUZZ"></span>			<span class="zmchat-tbbtn zmchat-savessBtn zmchat-bdisabled" id="zmchat-savessBtn-'+cI+'" title="Lưu"></span></div>			<div class="zmchat-input"><em class="zmchat_icoinput"></em><textarea id="zmchat-textAr-'+cI+'" tabindex="-1" onclick="this.focus();"></textarea><div class="clr"></div>			</div>'}function bT(cM,cO,cR){cM=zm.intval(cM);if(zm.inArray(cM,bE)>-1){cR&&zm("#zmchat-textAr-"+cM).focus();return}bE.push(cM);if(av[cM]!=undefined){zm("#"+x.FRIEND_CHATCONTENT+cM).html(av[cM]);delete av[cM]}else{if(cO){ar(cM)}}zm("#zmchat-popup-"+cM).show();var cI=zm("#zmchat-btn-"+cM),cJ=cE[cM]||T[cM],cQ=cI.parent(),cK=zm("#zmchat-btns").children(),cN=zm.inArray(cQ[0],cK);cI.addClass("active");if(cQ.css("display")=="none"||cN>ct+a1-1){cw(cM,cN)}cQ.addClass("active");var cL=zm("#zmchat-textAr-"+cM);cL.css("color",cJ.fontColor?cJ.fontColor:"#000000");(!Y||cR)&&cL.focus();!cL.val()&&cJ.text&&cL.val(cJ.text);cJ.typing!=undefined&&zmChat.updateTyping(cM,cJ.typing);if(av[cM]||b7[cM]){bY(cM)}bM();var cP=cN==ct&&zm("#zmchat-btnright").css("display")=="none";cQ[cP?"addClass":"removeClass"]("zmchat-lastBtn");aV(cM);bD();aG(cM)}function bj(cJ){var cI=zm.inArray(cJ,bE);cI>-1&&bE.splice(cI,1);zm("#zmchat-popup-"+cJ).hide();zm("#zmchat-colorsList").hide();zm("#zmchat-btn-"+cJ).removeClass("active").parent().removeClass("active");bM();var cK=zm("#zmchat-textAr-"+cJ);cE[cJ].text=cK.val();cK.val("");cK.blur();bD();aG()}function cf(cL,cM){cL=zm.intval(cL);av[cL]=zm("#"+x.FRIEND_CHATCONTENT+cL).html();var cK=zm("#zmchat-btnwp-"+cL),cI=zm.inArray(cK[0],zm("#zmchat-btns").children()),cN=cI-ct;cK.remove();zm("#zmchat-ctn-"+cL).hide();bO.splice(zm.inArray(cL,bO),1);var cJ=zm.inArray(cL,bE);if(cJ>-1){zm("#zmchat-textAr-"+cL).val("").blur();bE.splice(cJ,1)}aL(false);bD();cM&&al(cN);an(cL);cJ=zm.inArray(cL,G);if(cJ>-1){G.splice(cJ,1)}aG("remove")}function al(cN){if(a1<=0){return}var cK=ct+cN,cL=zm("#zmchat-btns").children(),cJ=cL.size();if(cK>=cJ){cK=cJ-1}var cI;while(cK>=ct){cI=cL.get(cK);if(cI.hasClass("active")){break}cK--}if(!cI){return}var cM=cI.attr("id").substr(13);zm("#zmchat-textAr-"+cM).focus()}function a6(cL,cJ){if(cJ===false){zm("#zmchat-popup-"+cL+" .zmchat-popup-header").removeClass("active")}else{for(var cK=0,cI;cI=bE[cK];cK++){cI!=cL&&zm("#zmchat-popup-"+cI+" .zmchat-popup-header").removeClass("active")}zm("#zmchat-popup-"+cL+" .zmchat-popup-header").addClass("active")}}function aG(cQ){var cM=cQ=="remove";if(a1==G){return}var cR=zm.getViewport().width,cK=G[ct-1],cO=G[ct+a1],cI=0;for(var cL=ct;cL<ct+a1;cL++){if(!G[cL]){continue}cI+=a(G[cL])}var cJ=cR-ck-cI;if(cQ&&!cM&&cJ<0){var cN=G[ct];if(cQ=="right"||cN==cQ){cN=G[ct+a1-1]}else{ct++}zm("#zmchat-btnwp-"+cN).hide();a1--}else{function cP(cS){if(cK&&(cJ-=a(cK))>0){zm("#zmchat-btnwp-"+cK).show();(!cM||cS)&&a1++;ct--}else{if(cO&&(cJ-=a(cO))>0){zm("#zmchat-btnwp-"+cO).show();(!cM||cS)&&a1++}}}cP();if(cM){cK=G[ct-1];cO=G[ct+a1];cP(true)}}bq();b(G.length>a1);bM()}function a(cI){if(!cI){return 0}if(zm.inArray(cI,bE)>-1){return k}return bo}function cw(cL,cP){var cN=zm("#zmchat-btns").children(),cJ=cP||zm.inArray(zm("#zmchat-btnwp-"+cL)[0],cN),cM=cN.size(),cK,cO,cI;if(cJ<0){return}if(cJ<ct){cO=cJ}else{if(cJ>ct+a1-1){cO=cJ-a1+1}}cI=cO+a1-1;for(cK=0;cK<cM;cK++){if(cK<cO||cK>cI){cN.get(cK).hide()}else{cN.get(cK).show()}}ct=cO;bM();bq()}function aU(cK){cK=cK||zm.getViewport().width;var cJ=0;for(var cI=ct;cI<ct+a1;cI++){if(!G[cI]){continue}cJ+=a(G[cI])}return cK-ck-cJ}function aL(cK,cJ){if(cK){if(aU()<(cJ&&k||bo)){zm("#zmchat-btnwp-"+G[ct]).hide();ct++;b(true,true)}else{a1++}}else{var cI=ct+a1-1;if(cI>=G.length){if(ct==0){a1--}else{ct--}cI=ct}zm("#zmchat-btnwp-"+G[cI]).show();b(G.length>a1)}bM(cK,cJ)}function bM(cL,cK){if(zm.browser.msie){var cI=0;for(var cJ=ct;cJ<ct+a1;cJ++){cI+=a(G[cJ])}if(cL){cI+=cK&&k||bo}zm("#zmchat-btns").css("width",cI+"px")}}function b(cJ,cI){if(cJ){zm("#zmchat-btnleft").show();zm("#zmchat-btnright").show();bq(cI)}else{zm("#zmchat-btnleft").hide();zm("#zmchat-btnright").hide()}}function bL(){zm("#zmchat-btnleft").click(function(){var cL=zm("#zmchat-btns").children(),cK=cL.size();if(ct+a1<cK){cL.get(ct).hide();var cI=cL.get(ct+a1).show(),cJ=cI.attr("id").substr(13);ct++;if(zm.inArray(cJ,bE)>-1){H[cJ]=0}bY(cJ);aG("left")}ah("left")});zm("#zmchat-btnright").click(function(){if(ct>0){var cM=zm("#zmchat-btns").children(),cL=cM.size(),cK=ct+a1-1;if(cK>=cL){cK=cL-1}cM.get(cK).hide();ct--;var cI=cM.get(ct).show(),cJ=cI.attr("id").substr(13);bM();if(zm.inArray(cJ,bE)>-1){H[cJ]=0}bY(cJ);aG("right")}ah("right")})}function bq(cI){if(ct==0){zm("#zmchat-btnright").addClass("zmchat-sdisabled")}else{zm("#zmchat-btnright").removeClass("zmchat-sdisabled")}var cJ=zm("#zmchat-btns").children();if(ct+a1+(cI?-1:0)==cJ.size()){zm("#zmchat-btnleft").addClass("zmchat-sdisabled")}else{zm("#zmchat-btnleft").removeClass("zmchat-sdisabled")}}function bu(cM,cJ,cO){if(!cE[cM]){return}var cI=zm("#zmchat-btn-"+cM);if(!H[cM]){H[cM]=0}if(cO!==false){H[cM]++}else{if(H[cM]==0){return}}if(!cJ){if(zm("#zmchat-newMsg-"+cM).size()<1){var cP=zm.createElement("DIV",{"class":"zmchat-newMsg",id:"zmchat-newMsg-"+cM});cI.append(cP)}zm("#zmchat-newMsg-"+cM).html(H[cM]).show();cI.addClass("zmchat-btnNewMsg")}var cQ=cI.parent();if(cQ.css("display")=="none"){var cN,cK=zm("#zmchat-btns").children(),cL=zm.inArray(cQ[0],cK);if(cL>-1&&cL<ct){cN="right"}else{if(cL>ct+a1-1){cN="left"}}if(cN){if(!aK[cN]){aK[cN]=setInterval(function(){var cR=zm("#zmchat-btn"+cN);if(cR.hasClass("zmchat-scrollNewMsg")){cR.removeClass("zmchat-scrollNewMsg")}else{cR.addClass("zmchat-scrollNewMsg")}},700)}}}}function aV(cI){if(!H[cI]){return}delete H[cI];zm("#zmchat-newMsg-"+cI).html("").hide();zm("#zmchat-btn-"+cI).removeClass("zmchat-btnNewMsg")}function cv(cM){var cI=0,cN=zm("#zmchat-btns").children(),cO,cJ;if(cM=="right"){cO=0;cJ=ct}else{cO=ct+a1;cJ=cN.size()-1}for(var cL=cO;cL<cJ;cL++){var cK=cN[cL].id.substr(8);cI+=zm.intval(H[cK])}return cI}function ah(cI){if(cv(cI)<=0){clearInterval(aK[cI]);delete aK[cI];zm("#zmchat-btn"+cI).removeClass("zmchat-scrollNewMsg")}}function cy(){for(var cI in cE){cE[cI].f!==0&&co(cE[cI])}}function co(cL,cR,cP){var cN=cL.u,cM=!!cL.i,cS=zm("#zmchat-btn-"+cN+" span");if(cM){cS.addClass("zmchat-fbtnIdle")}else{cS.removeClass("zmchat-fbtnIdle")}if(M&&am(cN)&&bI()-(cL.onlineTs||0)>bp){if(cL.hasOffline==undefined){cL.hasOffline=0}var cK=b4(cL.u),cI=cP||!cg(cN);if(cI){if(cL.f==1&&cL.hasOffline>0){zmChat.onError({to:cN,msg:cK+" đã online"});cL.hasOffline=0}cS.removeClass("zmchat-fbtnOffline").removeClass("zmchat-nobg")}else{if(cL.f==1&&cL.hasOffline==0){zmChat.onError({to:cN,msg:cK+" đã offline"})}cS.addClass("zmchat-fbtnOffline");cL.hasOffline++}}if(cR){return}var cQ=zm("#"+x.FRIENDITEM+cN).children();if(cQ&&cQ[0]){var cJ=cQ.children(),cO=cJ.filter(".zmchat-status");cO[cM?"addClass":"removeClass"]("zmchat-fIdle")}}function ci(cI,cJ){zm("#zmchat-btn-"+cI).children("span").html(cJ);zm("#zmchat-popup-"+cI+" a.zmchat-popup-title").html(cJ).attr("title",cJ)}function o(cL,cP){if(!cE[cL].n){return}var cK=cE[cL].n,cN=zm("#zmchat-popup-"+cL+" .zmchat-popupinfo"),cJ=cN.children(),cM=cJ.filter(".zmchat_txtusername"),cI=cN.outerWidth(true),cO=cJ.filter(".zmchat-popup-title").outerWidth(true)+cJ.filter(".zmechat-icotitle").outerWidth(true);cP&&cM.html("- "+cK).attr("title",cK).css("visibility","");if(cO<cI){cN.addClass("flowusername")}cP&&cM.css("visibility","")}function cg(cI){if(zm("#"+x.FRIENDITEM+cI).size()>0){return false}return true}function am(cI){return zm("#zmchat-btnwp-"+cI).size()>0}function bB(cI){return zm("#zmchat-btnwp-"+cI).css("display")=="none"}function bi(cI,cK){if(/m\.zing\.vn\/voice.*\.amr/i.test(cK.msg)){return false}var cJ=cK.id+"-"+cK.time;if(!aM[cI]){aM[cI]=new Array()}else{if(zm.inArray(cJ,aM[cI])!=-1){return false}}aM[cI].push(cJ);return true}function bW(cJ,cQ,cS,cK){var cN=cJ.fromU,cL;if(cN==zmChat.userId){cN=cJ.to;cL=zmChat.username}else{cL=cE[cN].n}var cP=cJ.fromU;if(!cK&&!bi(cN,cJ)){return}var cM=zm("#"+x.FRIEND_CHATCONTENT+cN);var cI=Math.floor(Math.random()*10000),cO=aa(cL),cR='<a class="zmchat-ctnName'+(cL==zmChat.username?" zmechat_txtgrey":"")+'" ';if(!cL){cR+='id="zcCtnName_'+cI+'" href="#"><strong>';bX(cJ.fromU,"zcCtnName_"+cI)}else{cR+='href="'+cO+'"><strong>'}cR+=cJ.fromD+"</strong></a>";cM.append('<div class="zmchat-ctn-groupMsg">'+cR+'<span class="zmchat-ctnTime">&nbsp;('+bl(cJ.time)+"):&nbsp;</span>"+cz(cJ.msg,{uid:cN,ignoreBuzz:cS})+"</div>");cQ&&bY(cN);b7[cN]={userid:cP,time:cJ.time,msg:cJ.msg};!P[cN]&&bP(cN,true)}function cz(cN,cK){var cL=cN,cJ;if(U(cN,cK.uid,!cK.ignoreBuzz)){cL="<strong>"+aX.TEXT+"</strong>";cJ=aX.COLOR}else{if(aW(cN)){cN=cN.replace(/[&><\"\n]/g,ac);cL='<a href="'+cN+'" target="_blank"><img src="'+cN+'" style="max-width: 200px;" /></a>'}else{if(aS(cN)){var cI=Math.floor(Math.random()*1000);cL='<div>				<a id="zmchat-vmpl'+cI+'" href="#" class="zmchat-vmplay" onclick="zmChat.playVoiceMsg('+cI+'); return false;" title="Bắt đầu nghe"><img src="http://'+zm.config.hostImage+'/images/blank.gif" alt="" /></a>				<a id="zmchat-vmst'+cI+'" href="#" class="zmchat-vmstop" onclick="zmChat.stopVoiceMsg('+cI+'); return false;" title="Dừng"><img src="http://'+zm.config.hostImage+'/images/blank.gif" alt="" /></a>			</div>';bx(cI,cN)}else{var cM=A(cL);if(cM&&cM.color){cL=cM.msg;cJ=cM.color}cL=cL.replace(/[&><\"\n]/g,ac);cL=zm.detectLink(cL,{target:"_blank"});cL=zm.renderEmotions(cL,{preventEntities:true,preventLink:true})}}}return'<span class="zmchat_msg"'+(cJ?(' style="color:'+cJ+'"'):"")+">"+cL+"</span>"}function U(cM,cI,cL){if(/^(^|#[0-9a-f]{1,6}\s)(\!buzz)$/i.test(zm.trim(cM))){if(cE[cI]&&cL){if(cE[cI].lastBuzzTime==undefined){cE[cI].lastBuzzTime=0}var cK=bI();if(cK-cE[cI].lastBuzzTime>=s){cE[cI].lastBuzzTime=cK;try{bn&&aN().playKnock()}catch(cJ){}J(cI)}}return true}return false}function J(cL){if((zm.browser.msie&&zm.browser.version<9)||!am(cL)||bB(cL)){return}var cK=zm("#zmchat-btnwp-"+cL),cJ=0,cM=[-6,0,6],cI=0,cO=0,cN=setInterval(function(){cJ+=10;if(cO==4||cO==0){cI=0}cI++;if(cI>2){cI=0}if(cO>=8){cO=0}if(cO>=0&&cO<4){cK.css("top",cM[cI]+"px")}if(cO>=4){cK.css("left",cM[cI]+"px")}cO++;if(cJ==300){cK.css({top:"",left:""});clearInterval(cN)}},10)}function A(cJ){var cI=new RegExp("^("+aJ.PREFIX_CODE+"[a-f0-9]{1,6})\\s+(.*)").exec(cJ);return(cI&&cI.length>2)?{color:cI[1],msg:cI[2]}:null}function aW(cI){if(S){return false}return/^http:\/\/.+\/.+\.(jpg|png|gif)$/i.test(cI)}function aS(cI){if(S){return false}return/^http:\/\/[^/]+(\.zing\.vn|\.zdn\.vn)\/.+\.(mp3|3gp)$/i.test(cI)}function bx(cI,cJ,cL){if(cL==undefined){cL=0}if(cL>5){return}var cK=aN();if(cK&&cK.addVoiceMessage){cK.addVoiceMessage(cI,cJ)}else{setTimeout(function(){bx(cI,cJ,cL+1)},1000)}}function bY(cI){var cJ=aE[cI];cJ&&setTimeout(function(){cJ.scrollToEnd()},100)}function d(){zm("#friend-online-more").click(function(){at();return false})}function C(cO){if(cq==1){return}var cN=zm("#friend-online-list"),cI=0,cL=zm.objectLength(cO);if(cN.size()==0){return}cN.html("");zm("#friend-online-title").html("Đang online ("+cL+")");var cK="",cM=cB;if(zmChat.params&&typeof zmChat.params.numItemsBox=="number"){cM=zmChat.params.numItemsBox}zm.each(cO,function(){if(cI>=cM){return false}cK+='<div class="avar-32" title="'+this.d+'" onclick="zmChat.chatWith('+this.u+');"><a href="#" onclick="return false;"><img src="'+a9(this.a)+'" /></a></div>';cI++});if(!cK){cK="<span>"+NOFRIEND_TEXT+"</span>"}cN.html(cK);var cJ=zm("#friend-online-more");if(cL>cM){cJ.show()}else{cJ.hide()}}function bG(){for(var cJ in aF){var cK=!cg(zm.intval(cJ));for(var cI=0,cL;cL=aF[cJ][cI];cI++){cL(cK)}}}function cs(cJ){var cI;if(typeof cJ==="string"){zm.each(cE,function(){if(this.n==cJ){cI=this.u;return false}})}else{if(typeof cJ==="number"){cI=cJ}}return cI}function b9(){var cI=zm("#zmchat-friendlist");(cI.size()<1||cI.children().size()<1)&&zm("#zmchat-message").html(au).show()}function ch(){zm("#zmchat-message").hide()}function cC(){zmChat.userId=zmChat.userId||zmConfig.viewerId;zmChat.username=zmChat.username||zmConfig.viewerName;zmChat.userDisplayname=zmChat.userDisplayname||zmConfig.viewerFullName;zmChat.avatar=zmChat.avatar||zmConfig.viewerAva50}function bP(cJ,cI){P[cJ]=cI;zm("#zmchat-savessBtn-"+cJ)[cI?"removeClass":"addClass"]("zmchat-bdisabled")}function D(cI){zm.storage.put("ticker_display."+zmChat.userId,cI,2592000,true)}function ab(){return zm.storage.get("ticker_display."+zmChat.userId,true)}return{init:function(){if(!this.params){return}cC();zm("#zmchat-optionsList").hide();zm("#zmchat-message").hide();zm("#zmchat-rpopupmin").hide();zm("#zmchat-topgrey").hide();zm("#zmchat-filterClr").hide();zm("#zmchat-btnleft").hide();zm("#zmchat-btnright").hide();!a8("canTest")&&zm("#zmchat-turnticker").hide();b9();zm("#zmchat").mouseup(function(){cA=false}).keydown(function(){cA=false}).keyup(function(){cA=false}).keypress(function(){cA=false}).show();bc();aI();bJ=this.params.displayFirst!==false;if(X){if(!bJ){this.displayTicker(false);zm("#zmchat-rpopupmin").hide()}else{bR(true);at()}D(bJ?1:2)}else{bQ();a3.setHeight(18);var cI=zm.storage.get("zmchat.list."+this.userId,true);if(cI==1&&bJ){at()}else{F()}ba();f();bH()}b1();d();bL();ag();bk();setInterval(function(){aZ()},ce);setTimeout(function(){var cJ=a8("canShow");if(!cJ){zm.storage.remove("ticker_display."+zmChat.userId)}},5000)},createProxy:function(cI){if(!this.params||ak){return}ak=true;var cJ=zm.createElement("iframe",{src:"http://chat.me.zing.vn/"+(cI||"proxy")+"-"+zmChat.params.proxyVersion+".html"},{position:"absolute",top:"-100px",width:"0px",height:"0px",visibility:"hidden"});zm(document.body).append(cJ)},setOnOff:function(cI){Z=cI},loadFriends:function(cI){b2=cI},send:function(cI){cb=cI},getChatHistory:function(cI){aC=cI},typing:function(cI){by=cI},recentChanged:function(cI){a4=cI},loadAvatar:function(cI){a2=cI},getInfo:function(cI){g=cI},saveSession:function(cI){be=cI},sendPm:function(cI){cG=cI},idle:function(cI){zm.idle(cI)},initData:function(cI){if(!cI.data){return}zmChat.updateOnOff(cI.data.o,true,true);B=cI.data.a},config:function(cI){b3=cI},isShowing:function(){return !!zm.storage.get("zmchat.list."+zmChat.userId,true)},updateOnOff:function(cN,cL,cO){ay=cN;if(cL){zm("#zmchat-offline").attr("checked",ay?"":"checked")}var cM=zm("#zmchat-label"),cJ=zm("#friend-online");if(ay){aI();var cI=zm("#zmchat-friendlist li").size();if(!cO){at();X=a8("canShow");if(X){bR(true)}D(1)}cM.text("Chat ("+cI+")");cJ.show();aZ()}else{if(X&&a8("getHeight")<zm.getViewport().height-30){a8("loadMore")}F();cM.text("Offline");zm("#zmchat-message").hide();cJ.hide();zm.storage.remove("zmchat.list."+zmChat.userId,true);for(var cK in cE){if(am(cK)){cf(cK)}}}X&&e(cF()[1])},onLoadFriends:function(cJ,cQ){if(!ay){return}cq++;b6=true;if(cJ){var cL=new Array();for(var cM=0;cM<cJ.length;cM++){try{var cO=cJ[cM].u;if(!cJ[cM].d){cJ[cM].d=cE[cO].d}if(!cJ[cM].n){cJ[cM].n=cE[cO].n}if(!cJ[cM].a){cJ[cM].a=cE[cO].a}if(!cJ[cM].n||!cJ[cM].d){cL.push(cM);continue}if(cE[cO]!=undefined){zm.extend(cE[cO],cJ[cM])}else{cE[cO]=cJ[cM]}cE[cO].f=1;var cS=cJ[cM].n;if(cS){var cI=zm.inArray(cO,cD);if(cI>-1){o(cO,true);cD.splice(cI,1)}}}catch(cP){}}for(var cK=0,cN;cN=cL[cK];cK++){cJ.splice(cN,1)}cJ.sort(bm);if(zm.hasStorage){try{if(!cQ){var cR="zmchat."+zmChat.userId;zm.storage.put(cR,{list:cJ,time:new Date().getTime()},ad)}}catch(cP){}}}ai(cJ);if(!M){E(true);M=true}else{E(true,true)}b6=false;bG();cy();bg();bd();cC()},onMessage:function(cJ){try{if(cJ.fromU!=zmChat.userId&&cJ.to!=zmChat.userId){return}var cW,cI=cJ.fromU==zmChat.userId;if(cI){cW={u:cJ.to};if(cE[cJ.to]){cW.d=cE[cJ.to].d}}else{cW={u:cJ.fromU,d:cJ.fromD,n:cJ.fromN}}var cR=cW.u;if(!bi(cR,cJ)){return}var cU=cg(cR),cP=zm.inArray(cR,bE)>-1,cQ=!cP&&am(cR),cV=cJ.fromU!=zmChat.userId&&!aH[cR];if(zm.tagfriend){var cO=zm.tagfriend.getFriendInfo(cR);if(cO){cW.n=cO[1];cW.d=cO[2]}cW.f=!!cO}if(!cW.n){cj({u:cR},function(cZ){if(!cZ||!cZ.data){return}var cY=cZ.data;if(!cE[cY.u]){cE[cY.u]={}}if(!cE[cY.u].d){ci(cY.u,cY.d)}zm.extend(cE[cY.u],cY);o(cY.u,true)})}bv(cW,!cQ,cV,cU);var cN=cE[cR];if((aT||cQ)&&!cI&&!U(cJ.msg)){try{bn&&aN().playPop()}catch(cS){}}if(cQ||bB(cR)){!cI&&bu(cR,cP)}else{aV(cR)}if(cN){cN.lastMsgTime=cJ.ts}var cL=aR[cJ.to]!=undefined;if(cL){var cX=zm.inArray(zm.intval(cJ.id),aR[cJ.to]);cL=cX!=-1;if(cL){aR[cJ.to].splice(cX,1)}}if(!cI||!cL){if(cI){var cM=A(cJ.msg);if(cM&&cM.color){cN.fontColor=cM.color}}bW(cJ,true,false,true)}if(!cI){cN.i=false;if(cU){cN.hasOffline=1;cA=false;aZ(true)}var cK=bI();if(cK-(cN.onlineTs||0)>bp){co(cN,true,cU)}else{delete cN.hasOffline}cN.onlineTs=cK;zmChat.updateTyping(cR,false);if(aT){cm++;zmNotifications.startAlert()}}}catch(cT){zm.log(cT.stack||cT)}},onError:function(cL){var cJ=zm("#"+x.FRIEND_CHATCONTENT+cL.to),cM=cL.msg,cK=cL.err;if(!cM){var cI=b4(cL.to);if(cK==-4){cM=cI+' hiện không online. Hãy <a href="#" rel="'+escape(cL.sentMsg.msg)+'" onclick="return zmChat.sendPmLink(this,'+cL.to+');">gửi tin nhắn này</a> cho '+cI;co(cE[cL.to],true);delete cE[cL.to].onlineTs}else{if(cK==-7){cM=cI+" không muốn chat với người lạ, hãy kết bạn để chat với "+cI+"."}else{if(cK==-11){if(zm.isNumber(cL.data)){cM="Bạn không thể chat đến "+t(cL.data)+" do đã gửi quá nhiều tin nhắn cùng lúc."}else{cM="Bạn không thể chat tiếp do đã gửi quá nhiều tin nhắn cùng lúc."}}else{if(cK==-10){cM="Nội dung này đã bị chặn."}else{if(cK!=0){cM="Có lỗi xảy ra, vui lòng thử lại sau."}else{cM=""}}}}}}if(cM){cJ.append('<div class="zmchat-err">'+cM+"</div>");bY(cL.to)}},onPopup:function(cI){if(!cH){cH=new Array()}if(zm.isFunction(cI)&&zm.inArray(cI,cH)<0){cH.push(cI)}},updateHistory:function(cL,cN,cK){if(!cN||cN.length<1){return}if(cK){zm("#zmchat-viewmore-"+cL).remove();delete aD[cL]}var cI=zm("#"+x.FRIEND_CHATCONTENT+cL);PROMOTE_MSG!=""&&cI.children(".zmchat-promotemsg").remove();var cM=cI.html();cI.html(PROMOTE_MSG);delete b7[cL];if(!cK&&cN.length>=m){cI.append('<div id="zmchat-viewmore-'+cL+'" style="padding: 5px 0;'+(PROMOTE_MSG?"border-top: 1px solid #e3e8ec;":"")+'"><a href="#">Xem nội dung cũ hơn</a></div>');zm("#zmchat-viewmore-"+cL+" a").click(function(){if(!aD[cL]){zm("#zmchat-viewmore-"+cL).append('<img src="http://'+zm.config.hostImage+'/images/loading_small.gif" style="margin-left:10px;" />');aD[cL]=true;ar(cL,true)}return false})}for(var cJ=0,cO;cO=cN[cJ];cJ++){bW(cO,false,true)}if(cM){cM=cM.replace(" zmchat-firstMsg","");cI.append(cM)}!cK&&bY(cL)},updateTyping:function(cJ,cI,cK){if(bS){return}if(cK>0&&cE[cJ].lastMsgTime>cK){return}cE[cJ].typing=cI;if(cI){zm("#zmchat-textAr-"+cJ).css("width","219px");zm("#zmchat-typing-"+cJ).show()}else{zm("#zmchat-textAr-"+cJ).css("width","238px");zm("#zmchat-typing-"+cJ).hide()}},updateRecent:function(cM){N=true;var cJ,cI,cL=cM.list||cM,cN=bO.length>0;for(cJ=0;cI=cL[cJ];cJ++){if(zm.inArray(cI[0],bO)==-1){bv({u:cI[0],d:cI[1],n:cI[2],f:cI[3]},cI[4]==1)}}az();var cK;for(cJ=0,cK;cK=bO[cJ];cJ++){if(!am(cK)){continue}ar(cK)}N=false;cN&&bD()},updateAvatar:function(cK,cI){if(cI){if(cK==zmChat.userId){zmChat.avatar=cI}else{cE[cK].a=cI}cd[cK]=false;for(var cJ=0,cL;cL=ax[cK][cJ];cJ++){zm("#"+cL).attr("src",a9(cI))}delete ax[cK]}},enableSound:function(cI,cJ){bn=cI;if(cJ){zm("#zmchat-sound").attr("checked",bn?"checked":"")}},changeSetting:function(cJ){if(!cJ||!cJ.id){return}var cI=cJ.checked;switch(cJ.id){case"zmchat-offline":aP({online:cI?0:1});break;case"zmchat-sound":q(cI);break;case"zmchat-otherchat":aP({chatall:cI?1:0});break}},canChat:function(cJ,cK){var cI=cs(cJ);if(zm.isFunction(cK)){if(!aF[cI]){aF[cI]=new Array()}zm.inArray(cK,aF[cI])==-1&&aF[cI].push(cK)}return !cg(cI)},chatWith:function(cL){var cK=cs(cL);if(cK){if(cE[cK].f===0){zm("#zmchat-filterInput").val("");cc()}typeof zmPW!="undefined"&&zmPW.hm();bv(cE[cK],true,true,false,true)}else{if(zmChat.DEBUG_USERS.indexOf(zmChat.userId+", ")>-1&&zm.isString(cL)){var cI=false;for(var cJ in T){if(T[cJ].n==cL){cI=true;break}}!cI&&cj({uname:cL},function(cM){if(cM.err==-6){zm("#zmchat-message").html(FRIENDFILTER_ERRTEXT)}else{zm("#zmchat-filterInput").val("");cc();typeof zmPW!="undefined"&&zmPW.hm();bv(zm.extend({n:cL},cM.data),true,true,false,true)}})}}},playVoiceMsg:function(cI){var cJ=zm("#zmchat-vmpl"+cI);if(cJ.hasClass("zmchat-vmpause")){aN().pauseVoiceMessage(cI);cJ.removeClass("zmchat-vmpause")}else{aN().playVoiceMessage(cI);cJ.addClass("zmchat-vmpause")}},stopVoiceMsg:function(cI){aN().stopVoiceMessage(cI);zm("#zmchat-vmpl"+cI).removeClass("zmchat-vmpause")},onVoiceMsgComplete:function(cI){zm("#zmchat-vmpl"+cI).removeClass("zmchat-vmpause")},sendPmLink:function(cK,cJ){var cI=zm(cK),cL=cI.attr("rel");if(cL){aO({toUid:cJ,msg:unescape(cL)});cI.parent().remove()}return false},displayTicker:function(cI,cJ){if(cI=="revert"){X=a8("canShow")&&!!ab()}else{X=cI}bR(X);if(!X){F()}cJ&&D(X?1:0)},onAutoresize:function(cI){if(!aB){aB=new Array()}if(zm.isFunction(cI)&&zm.inArray(cI,aB)<0){aB.push(cI)}},onAttachButtons:function(cI){if(!n){n=new Array()}if(zm.isFunction(cI)&&zm.inArray(cI,n)<0){n.push(cI)}},HEIGHT_RATIO:"5:5",DEBUG_USERS:"222496, 4053063, 10273615, 1598212, "}})();zm.ready(function(){if(zm.intval(zmConfig.viewerId)<=0){return}zmChat.init();zmChat.createProxy()});